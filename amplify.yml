version: 1
frontend:
  phases:
    preBuild:
      commands:
        - nvm use 20
        - echo "Creating .env.production file with environment variables"
        - |
          cat > .env.production << 'EOL'
          DATABASE_URI=${DATABASE_URI}
          PAYLOAD_SECRET=${PAYLOAD_SECRET}
          PAYLOAD_PUBLIC_SERVER_URL=https://${AWS_APP_ID}.amplifyapp.com
          PAYLOAD_PUBLIC_SITE_URL=https://${AWS_APP_ID}.amplifyapp.com
          ALGOLIA_APP_ID=${ALGOLIA_APP_ID}
          ALGOLIA_ADMIN_API_KEY=${ALGOLIA_ADMIN_API_KEY}
          ALGOLIA_SEARCH_API_KEY=${ALGOLIA_SEARCH_API_KEY}
          ALGOLIA_INDEX=${ALGOLIA_INDEX}
          S3_ACCESS_KEY=${S3_ACCESS_KEY}
          S3_SECRET_KEY=${S3_SECRET_KEY}
          S3_REGION=${S3_REGION}
          S3_BUCKET=${S3_BUCKET}
          S3_ENDPOINT=${S3_ENDPOINT}
          PGHOST=${PGHOST}
          PGPORT=${PGPORT}
          PGDATABASE=${PGDATABASE}
          PGUSER=${PGUSER}
          PGPASSWORD=${PGPASSWORD}
          PGSSLMODE=${PGSSLMODE}
          NEXT_BUILD_SKIP_DB=true
          EOL
        - npm install
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - '**/*'
  cache:
    paths:
      - node_modules/**/* 